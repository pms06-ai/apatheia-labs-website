services:
  # Local Postgres (mirrors Supabase schema)
  postgres:
    image: postgres:16-alpine
    container_name: phronesis-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: phronesis
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-localdev}
      POSTGRES_DB: phronesis
    ports:
      - '5432:5432'
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./supabase/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U phronesis']
      interval: 5s
      timeout: 5s
      retries: 5

  # Python processing environment
  python-tools:
    build:
      context: .
      dockerfile: docker/Dockerfile.python
    container_name: phronesis-python
    volumes:
      - ./scripts:/app/scripts:ro
      - ./tools:/app/tools:ro
      - python-output:/app/output
      - ${DOCUMENT_PATH:-./documents}:/app/documents:ro
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
    stdin_open: true
    tty: true
    command: ['tail', '-f', '/dev/null']

  # Repository audit system
  architect:
    build:
      context: ./infra/architect-brain
      dockerfile: Dockerfile
    container_name: phronesis-architect
    volumes:
      - .:/workspace/repos/apatheia-scaffold:ro
      - ./infra/architect-brain/audits:/workspace/audits
      - ./infra/architect-brain/knowledge:/workspace/knowledge
    environment:
      - REPOS_PATH=/workspace/repos
      - KNOWLEDGE_DB=/workspace/knowledge/architect.db
    stdin_open: true
    tty: true
    command: ['tail', '-f', '/dev/null']

volumes:
  pgdata:
  python-output:
